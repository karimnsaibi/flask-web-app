{% extends "base.html" %}
{% block title %}BI Dashboard{% endblock %}

{% block content %}
<div class="pt-28 pb-12 px-6 max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-[#1b1464]">Network Performance Dashboard</h1>
            <p class="text-gray-600 mt-2">Overview of Key Performance Indicators.</p>
        </div>
        <div class="flex space-x-4">
            <a href="/kpi/add" class="flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                <span>Log New Data</span>
            </a>
            <a href="/download/powerbi_data" class="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                <span>Export for PowerBI</span>
            </a>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" x-data="kpiStats()">
        <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-red-500">
            <h3 class="text-sm font-medium text-gray-500 uppercase">Avg Call Block Rate</h3>
            <p class="text-2xl font-bold text-gray-900 mt-2" x-text="stats.avgBlocage + '%'"></p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-yellow-500">
            <h3 class="text-sm font-medium text-gray-500 uppercase">Avg Call Drop Rate</h3>
            <p class="text-2xl font-bold text-gray-900 mt-2" x-text="stats.avgCoupure + '%'"></p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-green-500">
            <h3 class="text-sm font-medium text-gray-500 uppercase">Avg Availability</h3>
            <p class="text-2xl font-bold text-gray-900 mt-2" x-text="stats.avgDispo + '%'"></p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500">
            <h3 class="text-sm font-medium text-gray-500 uppercase">Total Data Traffic</h3>
            <p class="text-2xl font-bold text-gray-900 mt-2" x-text="stats.totalData + ' TB'"></p>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h3 class="text-lg font-bold text-gray-800 mb-4">QoS Trends (Blocage & Coupure)</h3>
            <canvas id="qosChart"></canvas>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Traffic Evolution</h3>
            <canvas id="trafficChart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('kpiStats', () => ({
            stats: {
                avgBlocage: '0.00',
                avgCoupure: '0.00',
                avgDispo: '0.00',
                totalData: '0.00'
            },
            async init() {
                const response = await fetch('/api/kpi_data');
                const data = await response.json();
                
                if(data.blocage.length > 0) {
                    this.stats.avgBlocage = (data.blocage.reduce((a,b)=>a+b,0) / data.blocage.length).toFixed(2);
                    this.stats.avgCoupure = (data.coupure.reduce((a,b)=>a+b,0) / data.coupure.length).toFixed(2);
                    this.stats.avgDispo = (data.dispo.reduce((a,b)=>a+b,0) / data.dispo.length).toFixed(2);
                    this.stats.totalData = (data.data.reduce((a,b)=>a+b,0) / 1024).toFixed(2); // Convert GB to TB
                }

                // Render Charts
                this.renderCharts(data);
            },
            renderCharts(data) {
                // QoS Chart
                new Chart(document.getElementById('qosChart'), {
                    type: 'line',
                    data: {
                        labels: data.dates,
                        datasets: [{
                            label: 'Taux Blocage (%)',
                            data: data.blocage,
                            borderColor: 'rgb(239, 68, 68)',
                            tension: 0.1
                        }, {
                            label: 'Taux Coupure (%)',
                            data: data.coupure,
                            borderColor: 'rgb(234, 179, 8)',
                            tension: 0.1
                        }]
                    },
                    options: { responsive: true }
                });

                // Traffic Chart
                new Chart(document.getElementById('trafficChart'), {
                    type: 'bar',
                    data: {
                        labels: data.dates,
                        datasets: [{
                            label: 'Data Traffic (Go)',
                            data: data.data,
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true }
                });
            }
        }))
    })
</script>
{% endblock %}
