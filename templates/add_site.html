{% extends "base.html" %}
{% block title %}Add GSM Site{% endblock %}

{% block content %}
<div class="pt-28 pb-12 px-6 max-w-3xl mx-auto">
  <div class="bg-white rounded-lg shadow-xl p-8">
    <div class="mb-8 border-b border-gray-200 pb-4">
      <h1 class="text-2xl font-bold text-[#1b1464]">Add New GSM Site</h1>
      <p class="text-gray-600 mt-1">Register a new base station into the network inventory.</p>
    </div>

    <form method="POST" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        
        <!-- Region Selection (Triggers Delegation & Code Load) -->
        <div class="col-span-1">
          <label class="block text-sm font-medium text-gray-700 mb-2">Region</label>
          <select name="region" id="regionSelect" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-white">
            <option value="" disabled selected>Select region</option>
            {% for gov in governorates %}
            <option value="{{ gov }}">{{ gov }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Delegation -->
        <div class="col-span-1">
          <label class="block text-sm font-medium text-gray-700 mb-2">Delegation</label>
          <select name="delegation" id="delegationSelect" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-50 disabled:bg-gray-100" disabled>
            <option value="" disabled selected>Select region first</option>
          </select>
        </div>

        <!-- Site Code -->
        <div class="col-span-1">
          <label class="block text-sm font-medium text-gray-700 mb-2">Site Code</label>
          <select name="site_code" id="codeSelect" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-50 disabled:bg-gray-100" disabled>
            <option value="" disabled selected>Select region first</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">Populated based on region's allocated pools.</p>
        </div>

        <!-- Site Name -->
        <div class="col-span-1">
          <label class="block text-sm font-medium text-gray-700 mb-2">Site Name</label>
          <input type="text" name="site_name" required placeholder="e.g. Center Ville" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
        </div>

        <!-- Coordinates -->
        <div>
           <label class="block text-sm font-medium text-gray-700 mb-2">X (Longitude)</label>
           <input type="number" step="any" name="x" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
           <label class="block text-sm font-medium text-gray-700 mb-2">Y (Latitude)</label>
           <input type="number" step="any" name="y" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
        </div>

        <!-- Technical Specs -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">HBA (Height)</label>
          <input type="number" step="0.1" name="hba" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
           <label class="block text-sm font-medium text-gray-700 mb-2">Supplier</label>
           <select name="supplier" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-white">
             <option value="">Select Supplier</option>
             <option value="Huawei">Huawei</option>
             <option value="Ericsson">Ericsson</option>
             <option value="Nokia">Nokia</option>
           </select>
        </div>

        <div>
           <label class="block text-sm font-medium text-gray-700 mb-2">Access Type</label>
           <select name="access" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-white">
             <option value="Fiber">Fiber Optic (FO)</option>
             <option value="Faisceau Hertzien">Microwave (FH)</option>
           </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Antenna Type</label>
          <input type="text" name="antenna" required placeholder="e.g. MIMO 4x4" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div class="col-span-2">
           <label class="block text-sm font-medium text-gray-700 mb-2">Surface / Location</label>
           <input type="text" name="surface" required placeholder="e.g. Rooftop, Greenfield" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
        </div>
      </div>

      <div class="pt-6 flex justify-end space-x-4 border-t border-gray-200 mt-6">
        <a href="/view-sites" class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition">Cancel</a>
        <button type="submit" class="px-8 py-2 bg-[#1b1464] text-white rounded-lg hover:bg-blue-900 transition shadow-lg flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            Create Site
        </button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const regionSelect = document.getElementById("regionSelect");
  const codeSelect = document.getElementById("codeSelect");
  const delegationSelect = document.getElementById("delegationSelect");

  // Load delegation list
  fetch("/static/data/delegations.json")
    .then(res => res.json())
    .then(data => {
      regionSelect.addEventListener("change", function () {
        const selectedRegion = this.value;

        // Enable inputs
        delegationSelect.disabled = false;
        delegationSelect.classList.remove('bg-gray-50');
        codeSelect.disabled = false;
        codeSelect.classList.remove('bg-gray-50');

        // Populate delegations
        const delegations = data[selectedRegion] || [];
        delegationSelect.innerHTML = '<option disabled selected>Select delegation</option>';
        delegations.forEach(del => {
          const opt = document.createElement("option");
          opt.value = del;
          opt.textContent = del;
          delegationSelect.appendChild(opt);
        });

        // Fetch site codes
        fetch(`/api/site-info?region=${selectedRegion}`)
          .then(res => res.json())
          .then(data => {
            codeSelect.innerHTML = '<option disabled selected>Select site code</option>';
            data.codes.forEach(code => {
              const opt = document.createElement("option");
              opt.value = code;
              opt.textContent = code;
              codeSelect.appendChild(opt);
            });
          });
      });
    });
});
</script>
{% endblock %}
