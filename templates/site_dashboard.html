{% extends "base.html" %}
{% block title %}Site Dashboard{% endblock %}

{% block content %}
<div class="pt-28 pb-12 px-6 max-w-7xl mx-auto" x-data="siteDashboard()">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-[#1b1464]">Site Inventory Dashboard</h1>
        <p class="text-gray-600 mt-2">Overview of network infrastructure distribution.</p>
    </div>

    <!-- Overview Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-600">
            <h3 class="text-sm font-medium text-gray-500 uppercase">Total Regions</h3>
            <p class="text-2xl font-bold text-gray-900 mt-2" x-text="data.regions.length"></p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-indigo-600">
            <h3 class="text-sm font-medium text-gray-500 uppercase">Total Suppliers</h3>
            <p class="text-2xl font-bold text-gray-900 mt-2" x-text="data.suppliers.length"></p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-purple-600">
            <h3 class="text-sm font-medium text-gray-500 uppercase">Sites Deployed</h3>
            <p class="text-2xl font-bold text-gray-900 mt-2" x-text="totalSites"></p>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
        <!-- Supplier Distribution -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Market Share by Supplier</h3>
            <div class="h-64 flex justify-center">
                <canvas id="supplierChart"></canvas>
            </div>
        </div>

        <!-- Access Type Distribution -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Transmission Type (Access)</h3>
            <div class="h-64 flex justify-center">
                <canvas id="accessChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Site Distribution by Region</h3>
        <div class="h-80">
            <canvas id="regionChart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('siteDashboard', () => ({
            data: { suppliers: [], regions: [], access_types: [] },
            totalSites: 0,
            
            async init() {
                const response = await fetch('/api/site_inventory');
                this.data = await response.json();
                
                // Calculate total sites
                this.totalSites = this.data.regions.reduce((acc, curr) => acc + curr.count, 0);

                this.renderCharts();
            },

            renderCharts() {
                // Supplier Doughnut
                new Chart(document.getElementById('supplierChart'), {
                    type: 'doughnut',
                    data: {
                        labels: this.data.suppliers.map(d => d.supplier || 'Unknown'),
                        datasets: [{
                            data: this.data.suppliers.map(d => d.count),
                            backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#6366f1']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // Access Pie
                new Chart(document.getElementById('accessChart'), {
                    type: 'pie',
                    data: {
                        labels: this.data.access_types.map(d => d.access || 'Unknown'),
                        datasets: [{
                            data: this.data.access_types.map(d => d.count),
                            backgroundColor: ['#8b5cf6', '#ec4899', '#06b6d4', '#64748b']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // Region Bar
                new Chart(document.getElementById('regionChart'), {
                    type: 'bar',
                    data: {
                        labels: this.data.regions.map(d => d.region),
                        datasets: [{
                            label: 'Number of Sites',
                            data: this.data.regions.map(d => d.count),
                            backgroundColor: '#1b1464',
                            borderRadius: 4
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
        }))
    })
</script>
{% endblock %}
